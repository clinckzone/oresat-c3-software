{% extends "base.html" %}

{% block content %}
  <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      margin-left: auto;
      margin-right: auto;
    }
    thead {
      font-weight: bold;
    }
    td, th {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
  </style>
  <b>Status:</b>
  <span id="systemStatus">ENABLED</span>
  <button id="enableSystemButton" onclick="enableSystem()">Disable System</button>
  <br />
  <b>Scan:</b>
  <button id="scanNodesButton" onclick="scan()">Scan for Nodes</button>
  <br />
  <b>Fault:</b>
  <span id="systemFault">NO_FAULT</span>
  <br />
  <b>Current:</b>
  <span id="systemCurrent">0.000</span> mA
  <br />
  <br />
  <div id="opdTableDiv">
    <table id="opdTable">
      <thead>
        <tr>
          <td>Card</td>
          <td>Address</td>
          <td>Status</td>
          <td>Control</td>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <script>
    const NODES = {
       0x18: "Battery 1",
       0x19: "GPS",
       0x1A: "IMU",
       0x1B: "DxWiFi",
       0x1C: "Star Tracker",
       0x1D: "CFC Processor",
       0x1E: "CFC Sensor",
       0x1F: "Battery 2",
       0x20: "Reaction Wheel 1",
       0x21: "Reaction Wheel 2",
       0x22: "Reaction Wheel 3",
       0x23: "Reaction Wheel 4",
    };

    const STATES = {
       0x00: "DISABLED",
       0x01: "ENABLED",
       0x02: "FAULT",
       0x03: "DEAD",
    };

    const NODE_STATES = {
       0x00: "DISABLED",
       0x01: "ENABLED",
       0x02: "FAULT",
       0x03: "DEAD",
       0xFF: "NOT_FOUND",
    };

    // build the table
    let tbodyRef = document.getElementById("opdTable").getElementsByTagName("tbody")[0];
    for (const key in NODES) {
      let newRow = tbodyRef.insertRow();

      let newCell = newRow.insertCell();
      let newText = document.createTextNode(NODES[key]);
      newCell.appendChild(newText);

      let newCell4 = newRow.insertCell();
      let upperHex = parseInt(key).toString(16).toUpperCase()
      let newText4 = document.createTextNode(`0x${upperHex}`);
      newCell4.appendChild(newText4);

      let newCell2 = newRow.insertCell();
      let span = document.createElement("span");
      span.id = `node${key}`;
      span.innerText = "DISABLED";
      newCell2.appendChild(span);

      let newCell3 = newRow.insertCell();
      let button = document.createElement("button");
      button.addEventListener("click", function() {nodeOnClick(key)});
      button.id = `node${key}Button`;
      button.innerText = "Enable";
      newCell3.appendChild(button);
    }

    /** Enable / disable a node button callback */
    async function nodeOnClick(nodeId) {
      await writeValue("opd", "node_select", nodeId);
      const enable = document.getElementById(`node${nodeId}Button`).innerText === "Enable";
      let data = await writeValue("opd", "node_status", Number(enable));
      updateNode(nodeId, data.value);
    }

    /** Update a row in the table */
    function updateNode(node, value) {
      const span = document.getElementById(`node${node}`);
      const button = document.getElementById(`node${node}Button`);

      const state = NODE_STATES[value];
      span.innerText = state;

      switch (state) {
      case "DISABLED":
        button.innerText = "Enable";
        button.disabled = false;
        break;
      case "ENABLED":
        button.innerText = "Disable";
        button.disabled = false;
        break;
      default:
        button.innerText = "Enable";
        button.disabled = true;
      }
    }

    /** Update data in the table */
    async function updateStatus() {
      const statusSpan = document.getElementById("systemStatus");
      const faultSpan = document.getElementById("systemFault");
      const currentSpan = document.getElementById("systemCurrent");
      const enableButton = document.getElementById("enableSystemButton");
      const spanButton = document.getElementById("scanNodesButton");
      const div = document.getElementById("opdTableDiv");
      let systemEnable = await readValue("opd","status");
      let systemFault = await readValue("opd","has_fault");
      let systemCurrent = await readValue("opd","current");
      let data;

      const status = STATES[systemEnable.value]

      if (status === "ENABLED" || status === "FAULT") { // only update if system is enabled
        data = await readValue("opd","nodes_status_json");
        const json = JSON.parse(data.value);
        for (const key in json) {
          updateNode(key, json[key]);
        }
      }

      if (systemFault.value === true) {
        faultSpan.innerText = "FAULT";
      } else {
        faultSpan.innerText = "NO_FAULT";
      }

      currentSpan.innerText = systemCurrent.value;

      // do this after the node updates to get the correct values before
      // showning table
      statusSpan.innerText = status;
      if (status === "ENABLED" || status === "FAULT") {
        enableButton.innerText = "Disable System";
        div.style.display = "";
        spanButton.disabled = false;
      } else {
        enableButton.innerText = "Enable System";
        div.style.display = "none";
        spanButton.disabled = true;
      }
    }

    /** Enable / disable the OPD subsystem button callback */
    async function enableSystem() {
      const enable = document.getElementById("systemStatus").innerText !== "ENABLED";
      const data = await writeValue("opd", "status", Number(enable));
      updateStatus();
    }

    /** Scan button callback */
    async function scan() {
      const data = await writeValue("opd", "scan", true);
      updateStatus();
    }

    updateStatus();
    const interval = setInterval(function() {
      updateStatus();
    }, 10000);
  </script>
{% endblock %}
